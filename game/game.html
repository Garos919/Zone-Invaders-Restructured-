<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- retro pixel font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <title>Zone Invaders</title>
  <style>
    * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', monospace;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      overflow: hidden;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    #gradientOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, transparent 0%, #000 70%);
      z-index: 0.5;
      pointer-events: none;
    }
    #pageLoadFade {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 10000;
      opacity: 1;
      transition: opacity 800ms ease-out;
      pointer-events: none;
    }
    #pageLoadFade.fade-out {
      opacity: 0;
    }
    #backgroundLayer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      background: #000;
      transition: background-color 0.5s ease;
    }
    #gradientOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 15%, rgba(0, 0, 0, 0) 100%);
      z-index: 10;
      pointer-events: none;
    }
    #gameContainer {
      position: relative;
      width: 700px;
      height: 700px;
      max-width: 95vw;
      max-height: 95vh;
      z-index: 11;
    }

    /* Mobile portrait optimization */
    @media (orientation: portrait) and (max-width: 768px) {
      #gameContainer {
        width: 95vw;
        height: 95vw;
        max-height: 70vh;
      }
    }

    /* Mobile landscape optimization */
    @media (orientation: landscape) and (max-height: 500px) {
      #gameContainer {
        width: 85vh;
        height: 85vh;
        max-width: 95vw;
      }
    }
    canvas {
      display: block;
      background: transparent;
      border: none;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      z-index: 1;
      touch-action: none;
    }
    #introOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: none;
      border: none;
      box-sizing: border-box;
      pointer-events: auto;
    }
    .logo-zoom {
      transform: scale(20) translateZ(1000px);
      opacity: 0;
      filter: brightness(0.5);
      transition: transform 2.5s cubic-bezier(0.2, 0, 0.8, 1),
                  opacity 2s cubic-bezier(0.4, 0, 0.6, 1),
                  filter 1.5s ease-in;
    }
    .dialogue-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      border: 2px solid #fff;
      padding: 25px;
      color: #fff;
      text-align: center;
      min-width: 300px;
      max-width: 90%;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-sizing: border-box;
    }

    @media (max-width: 480px) {
      .dialogue-box {
        padding: 15px;
        font-size: 10px;
        min-width: 250px;
      }
    }
    .dialogue-box.active {
      opacity: 1;
    }
    .cursor {
      display: inline-block;
      width: 10px;
      height: 16px;
      background: #fff;
      margin-left: 5px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .warning {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f33;
      font-size: 72px;
      text-shadow: 0 0 10px #f33;
      opacity: 0;
      animation: pulse 1s infinite;
    }

    @media (max-width: 480px) {
      .warning {
        font-size: 48px;
      }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .mission-text {
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f33;
      font-size: 20px;
      text-shadow: 0 0 10px #f33;
      opacity: 0;
      text-align: center;
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      .mission-text {
        font-size: 14px;
        white-space: normal;
        max-width: 90%;
      }
    }

    /* Mobile pause button */
    #mobilePauseBtn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #0ff;
      border-radius: 3px;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      cursor: pointer;
      touch-action: manipulation;
    }

    #mobilePauseBtn.active {
      display: flex;
    }

    #mobilePauseBtn:active {
      background: rgba(0, 255, 255, 0.2);
    }

    .pause-icon {
      width: 10px;
      height: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1px;
    }

    .pause-line {
      width: 2px;
      height: 6px;
      background: #0ff;
      border-radius: 0.5px;
    }

    /* Background stars for menu */
    .star {
      position: absolute;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      animation: twinkle 3s infinite;
      text-shadow: 0 0 4px currentColor;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Warning symbols for warning phase */
    .bg-warning {
      position: absolute;
      color: #f33;
      font-size: 48px;
      opacity: 0.3;
      animation: flash 1s infinite;
      text-shadow: 0 0 20px #f33;
    }
    @keyframes flash {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.5; }
    }

    /* Red pulsing hue for warning phase */
    @keyframes redPulse {
      0%, 100% { background-color: rgba(255, 0, 0, 0.1); }
      50% { background-color: rgba(255, 0, 0, 0.25); }
    }
  </style>
</head>
<body>
  <!-- Page load fade overlay -->
  <div id="pageLoadFade"></div>

  <div id="backgroundLayer"></div>

  <!-- Gradient overlay over background but under game window -->
  <div id="gradientOverlay"></div>

  <div id="gameContainer">
    <canvas id="game" width="700" height="700"></canvas>
    <div id="introOverlay">
      <div id="dialogueBox" class="dialogue-box">
        <span id="dialogueText"></span>
        <span id="cursor" class="cursor"></span>
      </div>
      <div id="warning" class="warning">âš </div>
      <div id="missionText" class="mission-text">ELIMINATE CODE ERRORS</div>
    </div>
    <div id="mobilePauseBtn">
      <div class="pause-icon">
        <div class="pause-line"></div>
        <div class="pause-line"></div>
      </div>
    </div>
  </div>

  <!-- Background Music -->
  <audio id="bgMusic" loop>
    <source src="assets/audio/main_menu.mp3" type="audio/mpeg">
    <source src="assets/audio/main_menu.ogg" type="audio/ogg">
    <source src="assets/audio/main_menu.wav" type="audio/wav">
  </audio>

  <!-- Sound Effects -->
  <audio id="pauseSound" preload="auto">
    <source src="assets/audio/pause.mp3" type="audio/mpeg">
  </audio>

  <audio id="unpauseSound" preload="auto">
    <source src="assets/audio/unpause.mp3" type="audio/mpeg">
  </audio>

  <audio id="whooshSound" preload="auto">
    <source src="assets/audio/whoosh.mp3" type="audio/mpeg">
  </audio>

  <audio id="digitalTypingSound" preload="auto">
    <source src="assets/audio/digital_typing.mp3" type="audio/mpeg">
  </audio>

  <audio id="warning1Sound" preload="auto">
    <source src="assets/audio/warning1.mp3" type="audio/mpeg">
  </audio>

  <audio id="warning2Sound" preload="auto">
    <source src="assets/audio/warning2.mp3" type="audio/mpeg">
  </audio>

  <audio id="hoverSound" preload="auto">
    <source src="assets/audio/hover.mp3" type="audio/mpeg">
  </audio>

  <audio id="explosionSound" preload="auto">
    <source src="assets/audio/explosion.mp3" type="audio/mpeg">
  </audio>

  <!-- Single entrypoint for ALL game code -->
  <script type="module" src="src/index.js"></script>

  <script>
    // Page load fade-in effect
    window.addEventListener('load', () => {
      const fadeOverlay = document.getElementById('pageLoadFade');
      if (fadeOverlay) {
        setTimeout(() => {
          fadeOverlay.classList.add('fade-out');
          setTimeout(() => { fadeOverlay.remove(); }, 800);
        }, 100);
      }
    });

    // Music Manager with fade effects
    const bgMusic = document.getElementById('bgMusic');
    let isFading = false;
    let currentFadeInterval = null;

    bgMusic.volume = 0;

    function fadeIn(duration = 2000, targetVolume = 0.3) {
      if (currentFadeInterval) { clearInterval(currentFadeInterval); currentFadeInterval = null; }
      isFading = true;
      const steps = 60, stepTime = duration / steps, volInc = targetVolume / steps;
      let i = 0;
      currentFadeInterval = setInterval(() => {
        i++;
        bgMusic.volume = Math.min(volInc * i, targetVolume);
        if (i >= steps) { clearInterval(currentFadeInterval); currentFadeInterval = null; isFading = false; }
      }, stepTime);
    }

    function fadeOut(duration = 1500) {
      if (currentFadeInterval) { clearInterval(currentFadeInterval); currentFadeInterval = null; }
      isFading = true;
      const start = bgMusic.volume, steps = 60, stepTime = duration / steps, dec = start / steps;
      let i = 0;
      currentFadeInterval = setInterval(() => {
        i++;
        bgMusic.volume = Math.max(start - (dec * i), 0);
        if (i >= steps) { clearInterval(currentFadeInterval); currentFadeInterval = null; bgMusic.pause(); isFading = false; }
      }, stepTime);
    }

    function fadeOutAndStop(duration = 1500) {
      if (currentFadeInterval) { clearInterval(currentFadeInterval); currentFadeInterval = null; }
      isFading = true;
      const start = bgMusic.volume, steps = 60, stepTime = duration / steps, dec = start / steps;
      let i = 0;
      currentFadeInterval = setInterval(() => {
        i++;
        bgMusic.volume = Math.max(start - (dec * i), 0);
        if (i >= steps) {
          clearInterval(currentFadeInterval); currentFadeInterval = null;
          bgMusic.pause(); bgMusic.currentTime = 0; isFading = false;
        }
      }, stepTime);
    }

    function startMusic() {
      if (!bgMusic.paused) return;
      bgMusic.play().then(() => { fadeIn(); musicStarted = true; })
        .catch(() => { console.log('Autoplay prevented. Music will start on first interaction.'); });
    }

    window.addEventListener('load', startMusic);

    let musicStarted = false;
    let allowMusicRestart = true;

    function tryStartMusic() {
      if (!musicStarted && bgMusic.paused && allowMusicRestart) startMusic();
    }

    document.addEventListener('click', tryStartMusic);
    document.addEventListener('keydown', tryStartMusic);
    document.addEventListener('touchstart', tryStartMusic);

    window.ensureMusicPlaying = startMusic;
    window.disableMusicRestart = () => { allowMusicRestart = false; };

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        fadeOut(500);
      } else if (musicStarted && allowMusicRestart) {
        bgMusic.play().then(() => fadeIn(1000));
      }
    });

    window.audioManager = {
      fadeIn, fadeOut, fadeOutAndStop,
      setVolume: (v) => { bgMusic.volume = Math.max(0, Math.min(1, v)); },
      play: () => bgMusic.play(),
      pause: () => bgMusic.pause(),
      isPlaying: () => !bgMusic.paused,

      playPause: () => {
        const el = document.getElementById('pauseSound');
        if (el) { el.currentTime = 0; el.volume = 0.5; el.play().catch(() => {}); }
      },
      playUnpause: () => {
        const el = document.getElementById('unpauseSound');
        if (el) { el.currentTime = 0; el.volume = 0.5; el.play().catch(() => {}); }
      },
      playWhoosh: () => {
        const el = document.getElementById('whooshSound');
        if (el) { el.currentTime = 0; el.volume = 0.6; el.play().catch(() => {}); }
      },
      playDigitalTyping: () => {
        const el = document.getElementById('digitalTypingSound');
        if (el) { el.currentTime = 0; el.volume = 0.5; el.play().catch(() => {}); }
      },
      playHover: () => {
        const el = document.getElementById('hoverSound');
        if (el) { el.currentTime = 0; el.volume = 0.3; el.play().catch(() => {}); }
      },
      playExplosion: () => {
        const el = document.getElementById('explosionSound');
        if (el) { el.currentTime = 0; el.volume = 0.5; el.play().catch(() => {}); return el; }
        return null;
      },
      fadeOutSound: (audioElement, duration) => {
        if (!audioElement) return;
        const start = audioElement.volume;
        const t0 = Date.now();
        const step = () => {
          const p = Math.min((Date.now() - t0) / duration, 1);
          audioElement.volume = start * (1 - p);
          if (p < 1) requestAnimationFrame(step);
          else { audioElement.pause(); audioElement.currentTime = 0; }
        };
        requestAnimationFrame(step);
      }
    };
  </script>
</body>
</html>
